<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="roadmap_page" name="Yetenek Yol Haritası">
        <t t-call="portal.portal_layout">
            <t t-set="no_breadcrumbs" t-value="True"/>
            <div class="container mt-4 mb-5">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-4">
                         <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1 text-primary fw-bold">
                                    <i class="fa fa-map-signs me-2"></i>Yetenek Yol Haritası
                                </h3>
                                <p class="text-muted mb-0">Seçtiğiniz yeteneklere özel gelişim planı.</p>
                            </div>
                            <a href="/stajyer/profile" class="btn btn-outline-secondary">
                                <i class="fa fa-arrow-left me-1"></i>Profil
                            </a>
                        </div>
                    </div>
                    
                    <div class="card-body p-4">
                        <t t-if="not skills_with_roadmap">
                            <div class="text-center py-5">
                                <i class="fa fa-lightbulb-o fa-4x text-warning mb-3 opacity-50"></i>
                                <h4>Henüz bir yol haritası bulunmuyor.</h4>
                                <p class="text-muted">Profilinizden yeteneklerinizi güncelleyerek ilgili yol haritalarını görebilirsiniz.</p>
                                <a href="/stajyer/profile" class="btn btn-primary mt-2">
                                    <i class="fa fa-edit me-2"></i>Profili Düzenle
                                </a>
                            </div>
                        </t>
                        <t t-else="">
                            <!-- Global CSRF Token for JS -->
                            <input type="hidden" id="csrf_token" t-att-value="request.csrf_token()"/>

                            <!-- Tabs -->
                            <ul class="nav nav-pills mb-4 d-flex flex-wrap gap-2 justify-content-start" id="pills-tab" role="tablist">
                                <t t-foreach="skills_with_roadmap" t-as="skill">
                                    <li class="nav-item" role="presentation">
                                        <button t-attf-class="nav-link #{'active' if skill_index == 0 else ''} fw-bold px-4 py-2 shadow-sm rounded-pill" 
                                                t-att-id="'pills-' + str(skill.id) + '-tab'" 
                                                data-bs-toggle="pill" 
                                                t-att-data-bs-target="'#pills-' + str(skill.id)" 
                                                type="button" role="tab" 
                                                t-att-aria-controls="'pills-' + str(skill.id)" 
                                                t-att-aria-selected="'true' if skill_index == 0 else 'false'">
                                            <t t-esc="skill.name"/>
                                        </button>
                                    </li>
                                </t>
                            </ul>
                            
                            <!-- Content -->
                            <div class="tab-content" id="pills-tabContent">
                                <t t-foreach="skills_with_roadmap" t-as="skill">
                                    <div t-attf-class="tab-pane fade #{'show active' if skill_index == 0 else ''}" 
                                         t-att-id="'pills-' + str(skill.id)" 
                                         role="tabpanel" 
                                         t-att-aria-labelledby="'pills-' + str(skill.id) + '-tab'">
                                        
                                        <!-- Admin: Add Item Button & Form -->
                                        <t t-if="is_admin">
                                             <div class="mb-4 text-end">
                                                 <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" t-att-data-bs-target="'#addRoadmapForm_' + str(skill.id)">
                                                     <i class="fa fa-plus me-1"></i> Yeni Madde Ekle
                                                 </button>
                                             </div>
                                             <div class="collapse mb-4" t-att-id="'addRoadmapForm_' + str(skill.id)">
                                                 <div class="card card-body bg-light border-0 shadow-sm">
                                                     <h6 class="fw-bold mb-3 text-primary">Yeni Yol Haritası Maddesi Ekle</h6>
                                                     <form action="/stajyer/roadmap/add" method="post">
                                                         <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                         <input type="hidden" name="skill_id" t-att-value="skill.id"/>
                                                         <div class="row g-3">
                                                             <div class="col-md-2">
                                                                 <input type="number" class="form-control" name="day" placeholder="Gün" required="required" min="1" value="1"/>
                                                             </div>
                                                             <div class="col-md-5">
                                                                 <input type="text" class="form-control" name="name" placeholder="Konu Başlığı" required="required"/>
                                                             </div>
                                                             <div class="col-md-5">
                                                                 <input type="text" class="form-control" name="url" placeholder="Kaynak Linki (Opsiyonel)"/>
                                                             </div>
                                                             <div class="col-12">
                                                                 <textarea class="form-control" name="description" rows="2" placeholder="Açıklama / İçerik Detayı"></textarea>
                                                             </div>
                                                             <div class="col-12 text-end">
                                                                 <button type="submit" class="btn btn-primary btn-sm">Kaydet</button>
                                                             </div>
                                                         </div>
                                                     </form>
                                                 </div>
                                             </div>
                                        </t>

                                        <div class="timeline position-relative">
                                            <div class="position-absolute start-0 top-0 bottom-0 ms-2 ms-md-4 border-start border-2 border-primary opacity-25"></div>
                                            
                                            <t t-foreach="skill.roadmap_ids" t-as="item">
                                                <div class="position-relative ps-3 ps-md-5 mb-4">
                                                    <t t-set="progress" t-value="progress_map.get(item.id)"/>
                                                    <t t-set="p_state" t-value="progress and progress.get('state')"/>
                                                    <t t-set="p_score" t-value="progress and progress.get('score', 0.0)"/>

                                                    <!-- Circle -->
                                                    <div t-att-id="'circle_' + str(item.id)" 
                                                         t-att-data-day="item.day"
                                                         class="position-absolute start-0 top-0 mt-1 bg-white border border-2 border-primary rounded-circle d-flex align-items-center justify-content-center fw-bold text-primary shadow-sm ms-0 ms-md-3"
                                                         style="width: 32px; height: 32px; z-index: 1;">
                                                        <t t-if="p_state == 'done'">
                                                            <i class="fa fa-check text-success"></i>
                                                        </t>
                                                        <t t-elif="p_state == 'failed'">
                                                            <i class="fa fa-times text-danger"></i>
                                                        </t>
                                                        <t t-else="">
                                                            <t t-esc="item.day"/>
                                                        </t>
                                                    </div>
                                                    
                                                    <!-- Card -->
                                                    <div t-att-id="'card_' + str(item.id)"
                                                         t-attf-class="card border-0 shadow-sm bg-light hover-shadow transition-all #{'border-success border-2' if p_state == 'done' else ''} #{'border-danger border-2' if p_state == 'failed' else ''}">
                                                        <div class="card-body p-3">
                                                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 mb-2">
                                                                <h5 class="card-title fw-bold mb-0 text-dark text-break">
                                                                    <t t-esc="item.name"/>
                                                                </h5>
                                                                
                                                                <!-- Actions -->
                                                                <div class="d-flex align-items-center gap-2 align-self-start align-self-sm-auto">
                                                                     <span class="badge bg-primary rounded-pill flex-shrink-0">
                                                                        <t t-esc="item.day"/>. Gün
                                                                    </span>
                                                                    
                                                                    <!-- Admin Actions -->
                                                                    <t t-if="is_admin">
                                                                        <button class="btn btn-sm btn-outline-warning border-0" type="button" data-bs-toggle="collapse" t-att-data-bs-target="'#editRoadmapForm_' + str(item.id)">
                                                                            <i class="fa fa-pencil"></i>
                                                                        </button>
                                                                         <button class="btn btn-sm btn-outline-danger border-0" type="button" t-att-onclick="'confirmDelete(' + str(item.id) + ')'">
                                                                            <i class="fa fa-trash"></i>
                                                                        </button>
                                                                        <form t-att-id="'deleteForm_' + str(item.id)" action="/stajyer/roadmap/delete" method="post" class="d-none">
                                                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                            <input type="hidden" name="item_id" t-att-value="item.id"/>
                                                                        </form>
                                                                    </t>
                                                                    
                                                                    <!-- Progress Actions (If not admin) -->
                                                                    <t t-if="False and not is_admin and stajyer and not item.question_ids and not item.checklist_ids">
                                                                         <div class="btn-group btn-group-sm ms-2" t-att-id="'btns_' + str(item.id)">
                                                                             <button type="button" t-attf-class="btn #{'btn-success' if p_state == 'done' else 'btn-outline-success'}" 
                                                                                     t-att-onclick="'updateProgress(' + str(item.id) + ', \'done\')'" title="Tamamladım">
                                                                                 <i class="fa fa-check"></i>
                                                                             </button>
                                                                             <button type="button" t-attf-class="btn #{'btn-danger' if p_state == 'failed' else 'btn-outline-danger'}" 
                                                                                     t-att-onclick="'updateProgress(' + str(item.id) + ', \'failed\')'" title="Yapamadım">
                                                                                 <i class="fa fa-times"></i>
                                                                             </button>
                                                                         </div>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                            
                                                            <t t-if="item.description">
                                                                <p class="card-text text-secondary mb-2 white-space-pre-line"><t t-esc="item.description"/></p>
                                                            </t>
                                                            
                                                             <t t-if="item.url">
                                                                <a t-att-href="item.url" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                                                                    <i class="fa fa-external-link me-1"></i>Kaynağa Git
                                                                </a>
                                                            </t>
                                                            
                                                            <!-- Main Interaction Logic -->
                                                            <t t-if="item.question_ids">
                                                                <!-- Quiz / Score Mode -->
                                                                <t t-if="p_state in ['done', 'failed']">
                                                                    <div t-attf-class="alert #{'alert-success' if p_state == 'done' else 'alert-danger'} mb-0 mt-3 p-3 shadow-sm border-0">
                                                                         <div class="d-flex justify-content-between align-items-center">
                                                                             <div>
                                                                                 <h5 class="mb-1 fw-bold">
                                                                                    <t t-if="p_state == 'done'">BAŞARILI</t>
                                                                                    <t t-else="">BAŞARISIZ</t>
                                                                                 </h5>
                                                                                 <div class="fs-5">
                                                                                    Puan: <strong t-esc="p_score"/>
                                                                                 </div>
                                                                                 <a t-att-href="'/stajyer/quiz/review?item_id=' + str(item.id)" class="btn btn-sm btn-light mt-2 fw-bold text-dark shadow-sm">
                                                                                     <i class="fa fa-eye me-1"></i> Cevapları Gör
                                                                                 </a>
                                                                             </div>
                                                                             <div class="text-end">
                                                                                 <i t-attf-class="fa #{'fa-check-circle' if p_state == 'done' else 'fa-times-circle'} fa-3x opacity-50"></i>
                                                                             </div>
                                                                         </div>
                                                                    </div>
                                                                </t>

                                                                

                                                                <t t-else="">
                                                                    <div class="mt-3">
                                                                        <a t-att-href="'/stajyer/quiz?item_id=' + str(item.id)" class="btn btn-primary shadow-sm py-2 px-4 fw-bold">
                                                                            <i class="fa fa-play-circle me-2"></i>Quize Gir
                                                                        </a>
                                                                    </div>
                                                                </t>
                                                            </t>
                                                            <t t-elif="item.checklist_ids">
                                                                <div class="mt-3 border-top pt-2">
                                                                    <t t-set="checklist_total" t-value="len(item.checklist_ids)"/>
                                                                    <t t-set="checklist_done_count" t-value="len([ck for ck in item.checklist_ids if ck.id in completed_checklist_ids])"/>                                                             
                                                                    
                                                                    <t t-foreach="item.checklist_ids" t-as="ck">
                                                                        <div class="form-check mb-1">   
                                                                            <input class="form-check-input" type="checkbox" t-att-id="'ck_' + str(ck.id)" 
                                                                                   t-att-checked="'checked' if ck.id in completed_checklist_ids else None"
                                                                                   t-att-onclick="'toggleChecklist(' + str(item.id) + ', ' + str(ck.id) + ', this.checked)'"
                                                                                   style="cursor: pointer;"/>
                                                                            <label class="form-check-label text-dark" t-att-for="'ck_' + str(ck.id)" style="cursor: pointer;">
                                                                                <small><t t-esc="ck.name"/></small>
                                                                            </label>
                                                                        </div>
                                                                    </t>
                                                                </div>
                                                            </t>
                                                            <!-- Admin Edit Form -->
                                                            <t t-if="is_admin">
                                                                <div class="collapse mt-3" t-att-id="'editRoadmapForm_' + str(item.id)">
                                                                    <div class="card card-body bg-white border">
                                                                        <form action="/stajyer/roadmap/edit" method="post">
                                                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                            <input type="hidden" name="item_id" t-att-value="item.id"/>
                                                                            <div class="row g-2">
                                                                                <div class="col-md-2">
                                                                                    <input type="number" class="form-control form-control-sm" name="day" required="required" t-att-value="item.day"/>
                                                                                </div>
                                                                                <div class="col-md-5">
                                                                                    <input type="text" class="form-control form-control-sm" name="name" required="required" t-att-value="item.name"/>
                                                                                </div>
                                                                                <div class="col-md-5">
                                                                                    <input type="text" class="form-control form-control-sm" name="url" placeholder="URL" t-att-value="item.url"/>
                                                                                </div>
                                                                                <div class="col-12">
                                                                                    <textarea class="form-control form-control-sm" name="description" rows="2"><t t-esc="item.description"/></textarea>
                                                                                </div>
                                                                                <div class="col-12 text-end">
                                                                                    <button type="submit" class="btn btn-primary btn-sm">Güncelle</button>
                                                                                </div>
                                                                            </div>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                        
                                        <t t-if="not skill.roadmap_ids">
                                            <div class="alert alert-info">
                                                Bu yetenek için henüz bir içerik eklenmemiş.
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Modal -->
            <div class="modal fade" id="quizModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="fa fa-question-circle me-2"></i>Qubi Quiz</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-4" id="quizModalBody">
                            <div class="text-center py-5">
                                <i class="fa fa-spinner fa-spin fa-3x text-primary"></i>
                                <p class="mt-2">Sorular Yükleniyor...</p>
                            </div>
                        </div>
                        <div class="modal-footer bg-light" id="quizModalFooter">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                            <button type="button" class="btn btn-success" onclick="submitQuiz()">Tamamla</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Toast Container (Centered) -->
            <style>
                #roadmapToast {
                    width: 100% !important;
                    max-width: 450px !important;
                }
                @media (max-width: 576px) {
                    #roadmapToast {
                        max-width: 90vw !important;
                    }
                }
                #roadmapToast .toast-body {
                    padding: 1rem !important;
                    font-size: 1rem;
                    word-wrap: break-word; /* Ensure text wraps */
                }
            </style>
            <div class="toast-container position-fixed top-50 start-50 translate-middle p-3" style="z-index: 1050; max-width: 100%;">
              <div id="roadmapToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                  <div class="toast-body w-100" id="roadmapToastMessage">
                    Toast Message
                  </div>
                </div>
              </div>
            </div>

            <script type="text/javascript"><![CDATA[
                var currentQuizItemId = null;
                
                function showToast(message, type) {
                    var toastEl = document.getElementById('roadmapToast');
                    var toastBody = document.getElementById('roadmapToastMessage');
                    
                    // Reset classes
                    toastEl.className = "toast align-items-center text-white border-0";
                    
                    if (type === 'success') {
                        toastEl.classList.add('bg-success');
                    } else if (type === 'error') {
                        toastEl.classList.add('bg-danger');
                    } else if (type === 'warning') {
                        toastEl.classList.add('bg-warning');
                        toastEl.classList.remove('text-white');
                    } else {
                        toastEl.classList.add('bg-primary');
                    }
                    
                    toastBody.innerHTML = message;
                    
                    if (window.bootstrap) {
                        var toast = new window.bootstrap.Toast(toastEl, { autohide: (type !== 'success' && type !== 'error') }); // Auto-hide only for warnings/info, not results
                        toast.show();
                    } else {
                        toastEl.classList.add('show');
                        if (type !== 'success' && type !== 'error') {
                            setTimeout(function() {
                                toastEl.classList.remove('show');
                            }, 4000);
                        }
                    }
                }
                
                // Helper to close modal from toast button
                function closeQuizModal() {
                    var modalEl = document.getElementById('quizModal');
                    if (window.bootstrap) {
                        var modal = bootstrap.Modal.getInstance(modalEl);
                        if(modal) modal.hide();
                    }
                    // Hide toast manually
                    var toastEl = document.getElementById('roadmapToast');
                    if (window.bootstrap) {
                        var toast = bootstrap.Modal.getInstance(toastEl); // Likely bootstrap.Toast
                        if(!toast) toast = new bootstrap.Toast(toastEl);
                        toast.hide();
                    } else {
                         toastEl.classList.remove('show');
                    }
                }

                function confirmDelete(itemId) {
                    if (confirm('Bu maddeyi silmek istediğinize emin misiniz?')) {
                        document.getElementById('deleteForm_' + itemId).submit();
                    }
                }
                
                function handleDoneClick(itemId) {
                     // Check if quiz exists
                     fetch('/stajyer/quiz/get_questions', {
                        method: 'POST',
                        body: JSON.stringify({ 'jsonrpc': '2.0', 'method': 'call', 'params': { 'item_id': itemId } }),
                        headers: { 'Content-Type': 'application/json' }
                     })
                     .then(response => response.json())
                     .then(data => {
                         if (data.result && data.result.questions) {
                             openQuizModal(itemId, data.result); // Use modal instead of redirect
                         } else if (data.result && data.result.error) {
                             showToast(data.result.error, 'error');
                         } else {
                             // If no questions and no error, likely just a manual passed item
                             updateProgress(itemId, 'done');
                         }
                     })
                     .catch(err => {
                         console.error("Quiz check failed", err);
                         showToast('Bağlantı hatası: Sorulara ulaşılamadı.', 'error');
                     });
                }
                
                function openQuizModal(itemId, data) {
                    currentQuizItemId = itemId;
                    var modalBody = document.getElementById('quizModalBody');
                    var html = '<h4 class="mb-4 text-center">' + data.item_name + ' Değerlendirmesi</h4>';
                    html += '<form id="quizForm">';
                    
                    data.questions.forEach(function(q, index) {
                        html += '<div class="card mb-3 border border-light shadow-sm">';
                        html += '<div class="card-body">';
                        
                        var qText = q.text ? q.text : '';
                        html += '<h6 class="card-title fw-bold">' + (index + 1) + '. ' + qText + '</h6>';
                        
                        // Image Display
                        if (q.has_image) {
                             html += '<div class="mb-3 text-center">';
                             html += '<img src="/web/image/stajyer.quiz.question/' + q.id + '/image" class="img-fluid rounded shadow-sm" style="max-height: 200px;">';
                             html += '</div>';
                        }
                        
                        html += '<div class="mt-3">';
                        q.options.forEach(function(opt) {
                             html += '<div class="form-check mb-2">';
                             html += '<input class="form-check-input" type="radio" name="q_' + q.id + '" id="opt_' + q.id + '_' + opt.key + '" value="' + opt.key + '">';
                             html += '<label class="form-check-label" for="opt_' + q.id + '_' + opt.key + '">' + opt.value + '</label>';
                             html += '</div>';
                        });
                        html += '</div></div></div>';
                    });
                    html += '</form>';
                    
                    modalBody.innerHTML = html;
                    document.getElementById('quizModalFooter').style.display = 'flex';
                    
                    var modalEl = document.getElementById('quizModal');
                    var modal;
                    if (window.bootstrap) {
                        modal = bootstrap.Modal.getInstance(modalEl);
                        if (!modal) {
                            modal = new bootstrap.Modal(modalEl);
                        }
                        modal.show();
                    } else {
                        // Fallback (unlikely)
                        modalEl.classList.add('show');
                        modalEl.style.display = 'block';
                        document.body.classList.add('modal-open');
                        var backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        document.body.appendChild(backdrop);
                    }
                }
                
                function submitQuiz() {
                    if (!currentQuizItemId) return;
                    
                    // Collect answers
                    var form = document.getElementById('quizForm');
                    var answers = {};
                    var allAnswered = true;
                    
                    var inputs = form.querySelectorAll('input[type="radio"]:checked');
                    inputs.forEach(function(input) {
                        var qId = input.name.split('_')[1];
                        answers[qId] = input.value;
                    });
                    
                    fetch('/stajyer/quiz/submit', {
                        method: 'POST',
                         body: JSON.stringify({ 
                             'jsonrpc': '2.0', 
                             'method': 'call', 
                             'params': { 
                                 'item_id': currentQuizItemId,
                                 'answers': answers
                             } 
                         }),
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        var res = data.result;
                         if (res && res.success) {
                             var msg = '<div class="text-center">';
                             var wrongCount = res.total_questions - res.correct_count;
                             
                             if (res.passed) {
                                 msg += '<h4 class="mb-3 border-bottom pb-2">TEBRİKLER!</h4>';
                                 msg += '<p class="fs-5 mb-2">' + res.message + '</p>';
                                 // Close modal and Reload to show Result Card
                                 var modalEl = document.getElementById('quizModal');
                                 var modal = bootstrap.Modal.getInstance(modalEl);
                                 modal.hide();
                                 setTimeout(function() {
                                     window.location.reload();
                                 }, 2000);
                             } else {
                                 msg += '<h4 class="mb-3 border-bottom pb-2">BAŞARISIZ!</h4>';
                                 msg += '<p class="fs-5 mb-2">' + res.message + '</p>';
                                 // Close modal and Reload to show Result Card
                                 var modalEl = document.getElementById('quizModal');
                                 var modal = bootstrap.Modal.getInstance(modalEl);
                                 modal.hide();
                                 setTimeout(function() {
                                     window.location.reload();
                                 }, 2000);
                             }
                             
                             msg += '<div class="row mb-3">';
                             msg += '<div class="col-6 text-end border-end"><span class="d-block small opacity-75">PUAN</span><span class="fs-4 fw-bold">' + res.score.toFixed(1) + '</span></div>';
                             msg += '<div class="col-6 text-start"><span class="d-block small opacity-75">D / Y</span><span class="fs-5"><i class="fa fa-check text-white"></i> ' + res.correct_count + ' / <i class="fa fa-times text-white opacity-50"></i> ' + wrongCount + '</span></div>';
                             msg += '</div>';
                            
                             msg += '<button onclick="closeQuizModal()" class="btn btn-light text-dark fw-bold w-100 shadow-sm"><i class="fa fa-arrow-left me-2"></i>Geri Dön</button>';
                             msg += '</div>';
                            
                             showToast(msg, res.passed ? 'success' : 'error');
                             
                             // Don't close modal automatically, let user see result and click Back
                         } else {
                             showToast('Hata: ' + (res ? res.message : 'Bilinmeyen hata'), 'error');
                         }
                    });
                }

                function updateProgress(itemId, state) {
                    var formData = new FormData();
                    formData.append('item_id', itemId);
                    formData.append('state', state);
                    
                    var csrfToken = document.getElementById('csrf_token');
                    if (csrfToken) {
                        formData.append('csrf_token', csrfToken.value);
                    }
                    
                    fetch('/stajyer/roadmap/progress', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                             throw new Error('Server returned ' + response.status);
                        }
                        return response.json()
                    })
                    .then(data => {
                        if (data.success) {
                            if (data.state === 'done') {
                                updateUiAsDone(itemId);
                            } else if (data.state === 'failed') {
                                // Failed UI logic
                                updateUiState(itemId, 'failed');
                            } else {
                                // Reset parsing
                                updateUiState(itemId, null);
                            }
                        } else {
                            if (data.error) {
                                showToast('Hata: ' + data.error, 'error');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Bağlantı hatası.', 'error');
                    });
                }
                
                function updateUiAsDone(itemId) {
                    updateUiState(itemId, 'done');
                }
                
                function updateUiState(itemId, state) {
                    var circle = document.getElementById('circle_' + itemId);
                    var card = document.getElementById('card_' + itemId);
                    var btns = document.getElementById('btns_' + itemId);
                    
                    // Reset classes
                    if (card) {
                        card.classList.remove('border-success', 'border-danger', 'border-2');
                    }
                    
                    // Update Circle and Card
                    if (state === 'done') {
                        if (circle) circle.innerHTML = '<i class="fa fa-check text-success"></i>';
                        if (card) card.classList.add('border-success', 'border-2');
                    } else if (state === 'failed') {
                        if (circle) circle.innerHTML = '<i class="fa fa-times text-danger"></i>';
                        if (card) card.classList.add('border-danger', 'border-2');
                    } else {
                        if (circle) circle.innerText = circle.getAttribute('data-day');
                    }
                    
                    // Update Buttons
                    if (btns) {
                        var doneBtn = btns.children[0];
                        var failBtn = btns.children[1];
                        
                        doneBtn.classList.remove('btn-success', 'btn-outline-success');
                        failBtn.classList.remove('btn-danger', 'btn-outline-danger');
                        
                        if (state === 'done') {
                            doneBtn.classList.add('btn-success');
                            failBtn.classList.add('btn-outline-danger');
                        } else if (state === 'failed') {
                            doneBtn.classList.add('btn-outline-success');
                            failBtn.classList.add('btn-danger');
                        } else {
                            doneBtn.classList.add('btn-outline-success');
                            failBtn.classList.add('btn-outline-danger');
                        }
                    }
                }

                function toggleChecklist(itemId, checklistId, checked) {
                     console.log('Toggling checklist:', itemId, checklistId, checked);
                     fetch('/stajyer/roadmap/toggle_checklist', {
                        method: 'POST',
                        body: JSON.stringify({ 
                             'jsonrpc': '2.0', 
                             'method': 'call', 
                             'params': { 
                                 'item_id': itemId,
                                 'checklist_id': checklistId,
                                 'checked': checked
                             } 
                        }),
                        headers: { 
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        console.log('Raw response:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data:', data);
                        var res = data.result;
                        if (res && res.success) {
                             if (res.quiz_ready) {
                                 // Redirect to quiz
                                 window.location.href = '/stajyer/quiz?item_id=' + itemId;
                             } else if (res.state === 'done') {
                                 // Mark as done
                                 updateUiState(itemId, 'done');
                             } else {
                                 // Incomplete / In progress
                                 updateUiState(itemId, null);
                             }
                        } else {
                            // Error, revert checkbox?
                            console.error('Checklist toggle failed', data);
                            if (data.error) {
                                showToast('Error: ' + JSON.stringify(data.error), 'error');
                            } else if (res && res.error) {
                                showToast(res.error, 'error');
                            } else {
                                showToast('Unknown error occurred', 'error');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        showToast('Network Error: ' + error, 'error');
                    });
                }
            ]]></script>
        </t>
    </template>
</odoo>
